<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audit Logs</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link th:href="@{/css/dashboard.css}" rel="stylesheet">
    <link th:href="@{/css/audit-logs.css}" rel="stylesheet">
    <style>

    </style>
</head>
<body>
<div th:replace="~{fragments/navbar :: navbar}"></div>
<div class="container mt-4">
    <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="bi bi-exclamation-triangle-fill me-2"></i>
        <span th:text="${error}">Error message appears here</span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0">
            <i class="bi bi-journal-text me-2"></i>Audit Logs
        </h1>
        <div>
            <button id="exportLogsBtn" class="btn btn-success">
                <i class="bi bi-download me-1"></i> Export Logs
            </button>
            <div id="exportSpinner" class="spinner-border spinner-border-sm text-primary ms-2"
                 style="display: none;"></div>
        </div>
    </div>


    <!--    <h1> Audit Logs</h1>-->
    <!--    <div class="mb-3">-->
    <!--        <button id="exportLogsBtn" class="btn btn-success">-->
    <!--            <i class="bi bi-download"></i> Export All Filtered Logs-->
    <!--        </button>-->
    <!--        <div id="exportSpinner" class="spinner-border text-primary ms-2" style="display: none;"></div>-->
    <!--    </div>-->
    <div class="filter-card">
        <form th:action="@{/logs}" method="get" class="mb-4">
            <div class="row g-3 align-items-end">
                <div class="col-md-3">
                    <label class="form-label small text-muted">Action</label>
                    <input type="text" name="action" placeholder="e.g. CREATE, UPDATE"
                           th:value="${param.action}" class="form-control">
                    <!--                    <input type="text" name="action" placeholder="Action"-->
                    <!--                           th:value="${param.action}" class="form-control">-->
                </div>

                <div class="col-md-3">
                    <label class="form-label small text-muted">Username</label>
                    <input type="text" name="username" placeholder="Filter by user"
                           th:value="${param.username}" class="form-control">
                    <!--                    <input type="text" name="username" placeholder="Username"-->
                    <!--                           th:value="${param.username}" class="form-control">-->
                </div>

                <div class="col-md-3">
                    <label class="form-label small text-muted">From</label>
                    <input type="datetime-local" name="startDate" th:value="${param.startDate}"
                           class="form-control" id="startDate"
                           onchange="document.getElementById('endDate').min = this.value;">
                </div>

                <div class="col-md-3">
                    <label class="form-label small text-muted">To</label>
                    <input type="datetime-local" name="endDate" th:value="${param.endDate}"
                           class="form-control" id="endDate"
                           onchange="document.getElementById('startDate').max = this.value;">
                </div>

                <div class="col-md-12 text-end">
                    <input type="hidden" name="size" th:value="${logs.size}">
                    <input type="hidden" name="page" value="0">
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-funnel me-1"></i> Apply Filters
                    </button>
                    <a th:href="@{/logs(size=${logs.size},page=0)}" class="btn btn-outline-secondary">
                        <i class="bi bi-x-circle me-1"></i> Clear
                    </a>
                    <!--                    <button type="submit" class="btn btn-primary">Filter</button>-->
                    <!--                    <a th:href="@{/logs(size=${logs.size},page=0)}" class="btn btn-outline-secondary">Clear</a>-->
                </div>

            </div>
        </form>
    </div>

    <div class="table-responsive">
        <table class="table table-striped table-hover">
            <thead>
            <tr>
                <td style="width: 5%">ID</td>
                <td style="width: 15%">Username</td>
                <td style="width: 15%">Action</td>
                <td style="width: 25%">Description</td>
                <td style="width: 20%">TimeStamp</td>
                <td style="width: 10%">Details</td>
            </tr>
            </thead>

            <tbody>
            <tr th:each="log : ${logs.content}" class="log-card">
                <td th:text="${log.id}" class="text-muted small"></td>
                <!--                <td th:text="${log.username}"></td>-->

                <td>
                     <span class="d-flex align-items-center">
                        <i class="bi bi-person-circle me-2 text-muted"></i>
                        <span th:text="${log.username}"></span>
                     </span>
                </td>
                <!--                <td th:text="${log.action}"></td>-->

                <td>
                     <span th:classappend="'action-badge action-' + ${log.action}"
                           th:text="${log.action.replace('_', ' ')}"></span>
                </td>


                <!--                <td th:text="${log.description}"></td>-->

                <td>
                    <div class="text-truncate" style="max-width: 300px;"
                         th:text="${log.description}"
                         th:title="${log.description}"></div>
                </td>


                <td th:text="${#temporals.format(log.timestamp, 'yyyy-MM-dd HH:mm:ss')}"
                    class="small"></td>
                <!--                <td>-->
                <!--                    <button class="btn btn-sm btn-outline-secondary"-->
                <!--                            data-bs-toggle="modal"-->
                <!--                            data-bs-target="#detailsModal"-->
                <!--                            th:attr="data-log-id=${log.id}">-->

                <!--                        <i class="bi bi-three-dots"></i>-->
                <!--                    </button>-->

                <!--                </td>-->
                <td class="text-end">
                    <button class="btn btn-sm btn-outline-primary"
                            data-bs-toggle="modal"
                            data-bs-target="#detailsModal"
                            th:attr="data-log-id=${log.id}">
                        <i class="bi bi-eye"></i> View
                    </button>
                </td>

            </tr>
            <tr th:if="${logs.empty}">
                <td colspan="6" class="text-center py-5">
                    <i class="bi bi-database-exclamation" style="font-size: 2rem; opacity: 0.3;"></i>
                    <p class="mt-3 text-muted">No logs found matching your criteria</p>
                </td>
            </tr>

            </tbody>

        </table>
    </div>
    <div class="card-footer bg-white border-0 pt-3">
        <div class="d-flex justify-content-between align-items-center">
            <form th:action="@{/logs}" method="get" class="col-md-2">
                <input type="hidden" name="page" value="0">
                <input type="hidden" name="action" th:value="${param.action}">
                <input type="hidden" name="username" th:value="${param.username}">
                <input type="hidden" name="startDate" th:value="${param.startDate}">
                <input type="hidden" name="endDate" th:value="${param.endDate}">
                <select name="size" class="form-select" onchange="this.form.submit()">
                    <option value="10" th:selected="${logs.size == 10}"> 10 per page</option>
                    <option value="15" th:selected="${logs.size == 15}"> 15 per page</option>
                    <option value="20" th:selected="${logs.size == 20}"> 20 per page</option>
                </select>
            </form>

            <nav>
                <form th:action="@{/logs}" method="get" class="btn-group">
                    <input type="hidden" name="size" th:value="${logs.size}">
                    <input type="hidden" name="action" th:value="${param.action}">
                    <input type="hidden" name="username" th:value="${param.username}">
                    <input type="hidden" name="startDate" th:value="${param.startDate}">
                    <input type="hidden" name="endDate" th:value="${param.endDate}">

                    <button type="submit" name="page" value="0"
                            class="btn btn-outline-primary pagination-btn"
                            th:disabled="${logs.first}">
                        <i class="bi bi-chevron-double-left"></i>
                    </button>

                    <button type="submit" name="page" th:value="${logs.number-1}"
                            class="btn btn-outline-primary pagination-btn"
                            th:disabled="${logs.first}">
                        <i class="bi bi-chevron-left"></i>
                    </button>

                    <span class="btn btn-light disabled">
                            Page <span th:text="${logs.number+1}"></span> of
                        <span th:text="${logs.totalPages}"></span>
                    </span>

                    <button type="submit" name="page" th:value="${logs.number + 1}"
                            class="btn btn-outline-primary pagination-btn"
                            th:disabled="${logs.last}">
                        <i class="bi bi-chevron-right"></i>
                    </button>

                    <button type="submit" name="page" th:value="${logs.totalPages-1}"
                            class="btn btn-outline-primary pagination-btn"
                            th:disabled="${logs.last}">
                        <i class="bi bi-chevron-double-right"></i>
                    </button>
                </form>
            </nav>
        </div>
    </div>

    <!--    <div class="d-flex justify-content-center mt-4">-->
    <!--        <form th:action="@{/logs}" method="get" class="btn-group">-->
    <!--            <input type="hidden" name="size" th:value="${logs.size}">-->
    <!--            <input type="hidden" name="action" th:value="${param.action}">-->
    <!--            <input type="hidden" name="username" th:value="${param.username}">-->
    <!--            <input type="hidden" name="startDate" th:value="${param.startDate}">-->
    <!--            <input type="hidden" name="endDate" th:value="${param.endDate}">-->
    <!--            <button type="submit" name="page" value="0"-->
    <!--                    class="btn btn-outline-primary"-->
    <!--                    th:disabled="${logs.first}">-->
    <!--                &laquo;-->
    <!--            </button>-->

    <!--            <button type="submit" name="page" th:value="${logs.number-1}"-->
    <!--                    class="btn btn-outline-primary"-->
    <!--                    th:disabled="${logs.first}">-->
    <!--                &lsaquo;-->
    <!--            </button>-->

    <!--            <span class="btn btn-light disabled">-->
    <!--                Page <span th:text="${logs.number+1}"></span>/<span th:text="${logs.totalPages}"></span>-->
    <!--            </span>-->

    <!--            <button type="submit" name="page" th:value="${logs.number + 1}"-->
    <!--                    class="btn btn-outline-primary"-->
    <!--                    th:disabled="${logs.last}">-->
    <!--                &rsaquo;-->
    <!--            </button>-->

    <!--            <button type="submit" name="page" th:value="${logs.totalPages-1}"-->
    <!--                    class="btn btn-outline-primary"-->
    <!--                    th:disabled="${logs.last}">-->
    <!--                &raquo;-->
    <!--            </button>-->

    <!--        </form>-->

    <!--    </div>-->

</div>

<div class="modal fade" id="detailsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <!--                <h5 class="modal-title">Details for Log #<span id="modalLogId"></span></h5>-->
                <h5 class="modal-title">
                    <i class="bi bi-journal-text me-2"></i>
                    Log Details #<span id="modalLogId"></span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <!--            <div class="modal-body p-0">-->
            <!--                <pre class="m-0 p-3 bg-light">-->
            <!--                    <code id="modalLogDetails" class="language-json">-->
            <!--                    </code>-->
            <!--                </pre>-->
            <!--            </div>-->
            <div class="modal-body p-0">
                <pre class="m-0"><code id="modalLogDetails" class="json-viewer"></code></pre>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="copyToClipboard()">
                    <i class="bi bi-clipboard"></i> Copy JSON
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-lg me-1"></i> Close
                </button>
            </div>
        </div>
    </div>
</div>

<div id="logs-data"
     hidden
     th:text="${logsJson}">
</div>

<script th:src="@{/js/view-details-modal.js}" defer></script>
<script th:src="@{/js/download-audit-logs.js}" defer></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>